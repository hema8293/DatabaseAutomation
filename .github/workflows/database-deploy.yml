name: CI/CD Pipeline for Database Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mysql-connector-python

      - name: Execute SQL script
        env:
          DB_HOST: priyacompanydb.mysql.database.azure.com
          DB_USER: priya
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_NAME: priyacompanydb
        run: |
          python - <<EOF
          import mysql.connector
          import os

          try:
              connection = mysql.connector.connect(
                  host=os.getenv("DB_HOST"),
                  user=os.getenv("DB_USER"),
                  password=os.getenv("DB_PASSWORD"),
                  database=os.getenv("DB_NAME"),
                  port=3306
              )

              cursor = connection.cursor()
              with open("schema_changes.sql", "r") as file:
                  sql_commands = file.read().split(";")

              for command in sql_commands:
                  if command.strip():
                      cursor.execute(command)

              connection.commit()
              print("âœ… SQL script executed successfully.")

          except mysql.connector.Error as err:
              print(f"âŒ Database Error: {err}")
              exit(1)

          finally:
              if 'connection' in locals() and connection.is_connected():
                  cursor.close()
                  connection.close()
                  print("ðŸ”— Connection closed.")
          EOF
